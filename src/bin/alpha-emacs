#!/bin/bash

# Prologue
set -e

# Managing test mode
if [ "$ALPHA_EMACS_TEST" == 'yes' ]
then
  echo -e "*** TEST MODE ENABLED ***\n"
  export HOME=`pwd`
fi

# Setting global variables
EMACSDIR="$HOME/.emacs.d"
ALPHADIR="$EMACSDIR/alpha"
MNGMTDIR="$ALPHADIR/management"
ALPHA_BOOTSTRAP="$MNGMTDIR/bootstrap.el"
ALPHA_REBUILD="$MNGMTDIR/rebuild.el"
ALPHA_UPDATE="$MNGMTDIR/update.el"

print_usage () {
  echo -e "Usage: install-alpha [COMMAND]\n\n" \
          "Commands:\n" \
          "  install           installs Alpha Emacs in user home directory\n" \
          "  rebuild           rebuild installed packages\n" \
          "  run               run installed Alpha Emacs\n" \
          "  update            update installed packages\n" \
          "  uninstall         completely uninstalls Alpha Emacs\n"
}

install_alpha_emacs () {
  local SRCDIR=./src
  echo "Installing Alpha Emacs..."
  if [ -d $EMACSDIR ]
  then
    if [ "$ALPHA_EMACS_TEST" != 'yes' ]
    then
      echo "User Emacs directory already exists."
      while true; do
        read -p "Do you wish to erase the content of user Emacs directory? (YES/no)" YN
        case $YN in
          YES)
            echo "Removing user Emacs directory..."
            rm -fr $EMACSDIR
            echo "User Emacs directory successfully removed"
            break
            ;;
          no)
            echo "Alpha Emacs installation cannot continue."
            exit 1
            ;;
          *)
            echo "please answer YES or no"
            ;;
        esac
      done
    fi
  fi
  if ! [ -d $EMACSDIR ]
  then
    echo "Creating Emacs user directory..."
    mkdir $EMACSDIR
    echo "Emacs user directory successfully created."
  fi
  echo "Installing Alpha Emacs files..."
  cp -r $SRCDIR/* $EMACSDIR/
  echo "Alpha Emacs files successfully installed."
  emacs -Q --batch -l $ALPHA_BOOTSTRAP
  exit 0
}

rebuild_alpha_emacs() {
  emacs -Q --batch -l $ALPHA_REBUILD
}

run_alpha_emacs () {
  echo "Running Alpha Emacs..."
  if [ "$ALPHA_EMACS_TEST" == 'yes' ]
  then
    emacs --debug-init
  else
    emacs
  fi
  echo "Finished running Alpha Emacs..."
}

update_alpha_emacs() {
  emacs -Q --batch -l $ALPHA_UPDATE
}

uninstall_alpha_emacs() {
  if [ -d $EMACSDIR ]
  then
    echo "Uninstalling Alpha Emacs..."
    rm -fr $EMACSDIR
    echo "Alpha Emacs successfully uninstalled."
    exit 0
  else
    echo "Alpha Emacs not installed yet."
    exit 1
  fi
}

case $1 in
  install)
    install_alpha_emacs
    ;;
  rebuild)
    rebuild_alpha_emacs
    ;;
  run)
    run_alpha_emacs
    ;;
  update)
    update_alpha_emacs
    ;;
  uninstall)
    uninstall_alpha_emacs
    ;;
  *)
    echo -e "No valid command provided.\n"
    print_usage
    ;;
esac
